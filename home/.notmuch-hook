#!/bin/bash
shopt -s nullglob

dirs=(
	~/"Maildir/gmail/[Gmail].All Mail"
	~/"Maildir/cs-au/INBOX"
	~/"Maildir/post-au/INBOX"
)

notification_text=""
total_new_mails=0
for d in "${dirs[@]}"; do
	new_dir="$d/new"
	new_mails=$(find "$new_dir" -type f | wc -l)
	if [[ $new_mails -gt 0 ]]; then
		for f in "$new_dir"/*; do
			echo "$f"
			from=$(sed 's/^From: //;t;d' "$f")
			subject=$(sed 's/^Subject: //;t;d' "$f")

			if [[ -n $notification_text ]]; then
				notification_text="$notification_text\n\n"
			fi

			notification_text="$notification_text$from:\n$subject"
		done
	fi

	total_new_mails=$((total_new_mails + new_mails))
done

if [[ $total_new_mails -gt 0 ]]; then
	notify-send "$total_new_mails new mails!" "$notification_text" --expire-time=0
fi

echo "$total_new_mails new mails..."

notmuch new

notmuch tag +inbox -- tag:new

notmuch tag -new -inbox +sent -- from:asgerdrewsen@gmail.com or from:drewsen@cs.au.dk or from:201407296@post.au.dk

notmuch tag -new -inbox +sent folder:'gmail/[Gmail].Sent Email'
notmuch tag -new -inbox +sent folder:'cs-au/Sent Items'
notmuch tag -new -inbox +sent folder:'post-au/Sent'

# Remove spam tags for mails no longer in any spam folder
notmuch tag -spam tag:spam and not folder:'gmail/[Gmail].Spam' and not folder:'cs-au/Junk Email' and not folder:'post-au/Junk'

# Tag spam
notmuch tag +spam folder:'gmail/[Gmail].Spam' and not folder:'gmail/INBOX'
notmuch tag +spam folder:'cs-au/Junk Email'
notmuch tag +spam folder:'post-au/Junk'
